/*
 * victim.c - Vulnerable Program with DT_RPATH/DT_RUNPATH
 *
 * This program is compiled with a library search path that can be exploited.
 * Common vulnerable patterns:
 *
 *   1. RPATH pointing to user-writable directory:
 *      gcc -Wl,-rpath,/tmp/libs -o victim victim.c -lhelper
 *
 *   2. RPATH with $ORIGIN (relative to binary location):
 *      gcc -Wl,-rpath,'$ORIGIN/libs' -o victim victim.c -lhelper
 *
 *   3. RUNPATH with writable path:
 *      gcc -Wl,--enable-new-dtags,-rpath,/home/user/libs -o victim victim.c -lhelper
 *
 * Compile: See Makefile for different vulnerability scenarios
 *
 * EDUCATIONAL PURPOSES ONLY
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

/* External functions from libhelper.so */
extern int process_data(const char *data);
extern int validate_input(const char *input);
extern const char *get_version(void);
extern int sensitive_operation(const char *auth_token);

/* Color codes */
#define CYAN    "\033[1;36m"
#define RESET   "\033[0m"

void display_banner(void) {
    printf("\n");
    printf("╔════════════════════════════════════════════════════════╗\n");
    printf("║       SECURE DATA PROCESSOR v2.0                       ║\n");
    printf("║       Using libhelper for operations                   ║\n");
    printf("╚════════════════════════════════════════════════════════╝\n");
    printf("\n");
}

void show_library_info(void) {
    printf("[*] Library version: %s\n", get_version());
    printf("[*] PID: %d\n\n", getpid());
}

int main(int argc, char *argv[]) {
    display_banner();
    show_library_info();

    /* Validate and process some data */
    const char *test_data = "sensitive_user_data_12345";

    printf("[*] Step 1: Validating input...\n");
    if (!validate_input(test_data)) {
        fprintf(stderr, "[!] Validation failed\n");
        return 1;
    }

    printf("\n[*] Step 2: Processing data...\n");
    int result = process_data(test_data);
    printf("[*] Processed %d bytes\n", result);

    printf("\n[*] Step 3: Performing sensitive operation...\n");
    const char *auth_token = "SECRET_AUTH_TOKEN_XYZ789";
    sensitive_operation(auth_token);

    printf("\n[*] All operations completed successfully.\n\n");

    return 0;
}
