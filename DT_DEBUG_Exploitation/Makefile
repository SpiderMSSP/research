# DT_DEBUG Exploitation POC - Makefile
#
# Usage:
#   make              - Build all components
#   make demo         - Run all demonstrations
#   make explore      - Run the DT_DEBUG explorer
#   make resolve      - Run the GOT resolver (no dlsym)
#   make abuse        - Run link_map manipulation demo
#   make clean        - Remove built files

CC = gcc
CFLAGS = -Wall -Wextra -g

# Targets
EXPLORER = dt_debug_explorer
RESOLVER = got_resolver
ABUSE = linkmap_abuse

.PHONY: all clean demo explore resolve abuse

all: $(EXPLORER) $(RESOLVER) $(ABUSE)

# ═══════════════════════════════════════════════════════════════════════════
# BUILD TARGETS
# ═══════════════════════════════════════════════════════════════════════════

$(EXPLORER): dt_debug_explorer.c
	$(CC) $(CFLAGS) -o $@ $< -ldl
	@echo "[+] Built: $@ (DT_DEBUG structure explorer)"

$(RESOLVER): got_resolver.c
	$(CC) $(CFLAGS) -o $@ $<
	@echo "[+] Built: $@ (Symbol resolution without dlsym)"

$(ABUSE): linkmap_abuse.c
	$(CC) $(CFLAGS) -o $@ $< -ldl
	@echo "[+] Built: $@ (Link_map manipulation & debugging detection)"

# ═══════════════════════════════════════════════════════════════════════════
# DEMONSTRATION TARGETS
# ═══════════════════════════════════════════════════════════════════════════

demo: all explore resolve abuse
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  ALL DEMONSTRATIONS COMPLETE"
	@echo "════════════════════════════════════════════════════════════════"

explore: $(EXPLORER)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  DT_DEBUG STRUCTURE EXPLORATION"
	@echo "════════════════════════════════════════════════════════════════"
	./$(EXPLORER)

resolve: $(RESOLVER)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  SYMBOL RESOLUTION WITHOUT DLSYM"
	@echo "════════════════════════════════════════════════════════════════"
	./$(RESOLVER)

abuse: $(ABUSE)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  LINK_MAP MANIPULATION & DEBUGGER DETECTION"
	@echo "════════════════════════════════════════════════════════════════"
	./$(ABUSE)

# Run under GDB to trigger debugger detection
debug-test: $(ABUSE)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  TESTING DEBUGGER DETECTION (under GDB)"
	@echo "════════════════════════════════════════════════════════════════"
	@echo ""
	@echo "Run: gdb -ex 'run' -ex 'quit' ./$(ABUSE)"
	@echo ""
	gdb -batch -ex 'run' -ex 'quit' ./$(ABUSE) 2>/dev/null || ./$(ABUSE)

# Show r_debug with GDB
show-rdebug: $(EXPLORER)
	@echo ""
	@echo "════════════════════════════════════════════════════════════════"
	@echo "  EXAMINING R_DEBUG WITH GDB"
	@echo "════════════════════════════════════════════════════════════════"
	@echo ""
	gdb -batch \
		-ex 'break main' \
		-ex 'run' \
		-ex 'print _r_debug' \
		-ex 'print *_r_debug.r_map' \
		-ex 'quit' ./$(EXPLORER) 2>/dev/null || echo "(GDB not available)"

clean:
	rm -f $(EXPLORER) $(RESOLVER) $(ABUSE)
	@echo "[+] Cleaned"
